<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Specialisation :: openEHR Specifications (Local Build)</title>
    <link rel="canonical" href="https://sebastian-iancu.github.io/antora-openehr/AM/Release-2.2.0/ADL2/specialisation/">
    <link rel="prev" href="../terminology_integration/">
    <link rel="next" href="../templates/">
    <meta name="description" content="openEHR Archetype Definition Language 2 (ADL2)">
    <meta name="keywords" content="EHR, ADL, AOM, health records, archetypes, constraint language, ISO 13606, openehr">
    <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/antora-openehr.css">
    <link rel="stylesheet" href="../../../../_/css/openehr.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://sebastian-iancu.github.io/antora-openehr">openEHR Specifications (Local Build)</a>

      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field has-filter">
          <input id="search-input" type="text" placeholder="Search the docs">
          <label class="filter checkbox">
            <input type="checkbox" data-facet-filter="component:AM"> Archetype Model only
          </label>
        </div>
      </div>

      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Specifications</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://specifications.openehr.org/" target="_blank">
              openEHR specification
            </a>
            <a class="navbar-item" href="https://specifications.openehr.org/releases/UML/development/index.html" target="_blank">
              openEHR portal
            </a>
            <a class="navbar-item" href="https://ckm.openehr.org/ckm/" target="_blank">
              openEHR CKM
            </a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Community</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://openehr.atlassian.net/secure/Dashboard.jspa?selectPageId=10190" target="_blank">
              Issue trackers
            </a>
            <a class="navbar-item" href="https://discourse.openehr.org/" target="_blank">
              Discourse Forum
            </a>
            <a class="navbar-item" href="https://specifications.openehr.org/wiki/display/spec/Specifications+Home" target="_blank">
              Wiki
            </a>
            <a class="navbar-item" href="https://github.com/openEHR" target="_blank">
              GitHub
            </a>
          </div>
        </div>

      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="AM" data-version="Release-2.2.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../">Archetype Model</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../">Overview</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../ADL1.4/">{spec_title}</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/preface/">Preface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/overview/">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/file_encoding/">File Encoding and Character Quoting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/dadl/">dADL - Data ADL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/cadl/">cADL - Constraint ADL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/assertions/">Assertions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/paths/">ADL Paths</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/adl/">ADL - Archetype Definition Language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/customising_adl/">Customising ADL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/other_formalisms/">Relationship of ADL to Other Formalisms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/masterAppB-extended_metadata/">Extended Meta-data Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/masterAppC-syntax_spec/">Syntax Specification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ADL1.4/amendment_record/">Amendment Record</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../">{spec_title}</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../preface/">Preface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overview/">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../file_encoding/">File Encoding and Character Quoting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cadl/">cADL - Constraint ADL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../paths/">ADL Paths</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../default_values/">Default Values</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adl/">ADL - Archetype Definition Language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../terminology_integration/">Terminology Integration</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">Specialisation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../templates/">Templates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../other_formalisms/">Relationship of ADL to Other Formalisms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../masterAppB-syntax_spec/">Syntax Specification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../amendment_record/">Amendment Record</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../AOM1.4/">{spec_title}</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/preface/">Preface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/model_overview/">The Archetype Object Model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/archetype_package/">The Archetype Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/constraint_model_package/">Constraint Model Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/assertion_package/">The Assertion Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/primitive_package/">Primitive Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/ontology_package/">Terminology Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/domain_extension/">Domain-specific Extension Example</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/masterAppB-diverse_reference_models/">Using Archetypes with Diverse Reference Models</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/masterAppC-rm_dependencies/">Reference Model Dependencies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM1.4/amendment_record/">Amendment Record</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../AOM2/">{spec_title}</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/preface/">Preface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/model_overview/">Model Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/archetype_package/">The Archetype Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/constraint_model_package/">Constraint Model Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/rules_package/">The Rules Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/rm_overlay/">The RM Overlay Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/terminology_package/">Terminology Package</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/validation/">Validation and Transformation Semantics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/serialisation_model/">Serialisation Model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/templates/">Templates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/rm_adaptation/">Reference Model Adaptation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../AOM2/amendment_record/">Amendment Record</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../Identification/">{spec_title}</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/preface/">Preface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/overview/">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/artefact_source_id/">Source Artefact Identification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/versioning/">Versioning</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/lifecycle_mgt/">Lifecycle Model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/distributed_governance/">Distributed Governance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/referencing/">Referencing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/uris/">A Reliable URI for Knowledge Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/artefact_authentication/">Artefact Authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/scenarios/">Scenarios</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Identification/amendment_record/">Amendment Record</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#index.adoc">Language Design</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../OPT2/">{spec_title}</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../OPT2/preface/">Preface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../OPT2/overview/">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../OPT2/opt_raw/">The Raw Operational Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../OPT2/opt_profiled/">The Profiled Operational Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../OPT2/file_formats/">File Formats</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../OPT2/amendment_record/">Amendment Record</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../Overview/">{spec_title}</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Overview/introduction/">Business Purpose of Archetypes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Overview/formalism_overview/">Archetype Formalism Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Overview/the_specifications/">The Specifications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Overview/semantic_overview/">Semantic Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Overview/artefacts/">Artefacts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../Overview/amendment_record/">Amendment Record</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Archetype Model</span>
    <span class="version">Release-2.2.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../../../latest/">Archetype Model</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../latest/">Release-2.3.0</a>
        </li>
        <li class="version is-current">
          <a href="../../">Release-2.2.0</a>
        </li>
        <li class="version">
          <a href="../../../development/">development</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../BASE/latest/">Base Model</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../BASE/latest/">Release-1.2.0</a>
        </li>
        <li class="version">
          <a href="../../../../BASE/Release-1.1.0/">Release-1.1.0</a>
        </li>
        <li class="version">
          <a href="../../../../BASE/development/">development</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../RM/latest/">Reference Model</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../RM/latest/">Release-1.1.0</a>
        </li>
        <li class="version">
          <a href="../../../../RM/Release-1.0.4/">Release-1.0.4</a>
        </li>
        <li class="version">
          <a href="../../../../RM/development/">development</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../BASE/latest/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../">Archetype Model</a></li>
    <li><a href="../">{spec_title}</a></li>
    <li><a href="./">Specialisation</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">Release-2.2.0</button>
  <div class="version-menu">
    <a class="version is-missing" href="../../../latest/">Release-2.3.0</a>
    <a class="version is-current" href="./">Release-2.2.0</a>
    <a class="version is-missing" href="../../../development/">development</a>
  </div>
</div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Specialisation</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a><a class="link" href="#_overview">Overview</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Archetypes can be specialised in a similar way to classes in object-oriented programming languages. Common to both situations is the use of a differential style of declaration, i.e. the contents of a specialised artefact are expressed as differences with respect to the parent artefact - previously defined elements from the parent that are not changed are not repeated in the descendant. Two extra constructs are included in the ADL syntax to support redefinition in specialised archetypes or templates.</p>
</div>
<div class="paragraph">
<p>The basic test that must be satisfied by a specialised archetype is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All possible data instance arrangements that conform to the specialised archetype must also conform to all of its parents, recursively to the ultimate parent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This condition ensures that data created by a specialised archetype that is not itself shared by two systems can be processed by the use of a more general parent that is shared.</p>
</div>
<div class="paragraph">
<p>The semantics that allow this are similar to the 'covariant redefinition' <a href="#cov_contra">[cov_contra]</a> notion used in some object-oriented programming languages, and can be summarised as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A non-specialised (i.e. top-level) archetype defines an instance space that is a subset of the space defined by the class in the reference information model on which the archetype is based.</p>
</li>
<li>
<p>A specialised archetype can specialise only one parent archetype, i.e. single inheritance.</p>
</li>
<li>
<p>A specialised archetype specifies an instance space defined by the following elements:</p>
<div class="ulist">
<ul>
<li>
<p>unchanged object and attribute constraints inherited from the parent archetype;</p>
</li>
<li>
<p>and one or more redefinitions, additions and removals.</p>
</li>
</ul>
</div>
</li>
<li>
<p>All elements defined in a parent archetype are either inherited unchanged or redefined in a specialised child.</p>
</li>
<li>
<p>Specialised archetypes are expressed differentially with respect to the parent, i.e. they do not mention purely inherited elements, only redefinitions and extensions.</p>
</li>
<li>
<p>Extensions always define an additional subset of the instance space defined by the reference model element being extended (i.e. to which the 'new' objects belong). The extension capability allows archetypes to remain extensible without having to know in advance how or if they will be extended.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To understand specialisation properly, the object-oriented notion of flattening is required. This term refers to the operation of overlaying the (differential) definition of a specialised archetype on its 'flat parent', which is a flattened archetype obtained by a previous invocation of this process. The first invocation creates a flat archetype from overlaying a specialised archetype on a 'top-level' non-specialised archetype.</p>
</div>
<div class="paragraph">
<p>The contents of the definition of any specialised archetype are therefore understood as differences with respect to the <em>flat parent</em>, not the differential parent. This is exactly how object-oriented programming languages work.</p>
</div>
<div class="paragraph">
<p>The following sections describe the details of specialisation. The term 'object' is used synonymously with 'object constraint' since all elements in ADL are constraints unless otherwise indicated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specialisation_concepts"><a class="anchor" href="#_specialisation_concepts"></a><a class="link" href="#_specialisation_concepts">Specialisation Concepts</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_differential_and_flat_forms"><a class="anchor" href="#_differential_and_flat_forms"></a><a class="link" href="#_differential_and_flat_forms">Differential and Flat Forms</a></h3>
<div class="paragraph">
<p>Specialised archetypes in their authored form are represented in 'differential' form. The syntax is the same as for non-specialised archetypes, with two additions: specialisation paths (see <a href="#_specialisation_paths">Specialisation Paths</a>) and ordering indicators (see <a href="#_ordering_of_sibling_nodes">Ordering of Sibling Nodes</a>). For a specialised archetype therefore, the lineage of archetypes back to the ultimate parent must be taken into account in order to obtain its complete semantics.</p>
</div>
<div class="paragraph">
<p>Differential form means that the only attributes or objects mentioned are those that redefine corresponding elements in the parent and those that introduce new elements. The differential approach to representation of specialised archetypes give rise to the need for a <em>flat form</em> of a specialised archetype: the equivalent archetype defined by the sum of the (differential) child and its parent, as if the child archetype had been defined standalone. The flat form of archetypes is used for building templates, and subsequently at runtime. It is generated by 'compressing' the effects of inheritance of the parent to the specialised child into a single archetype, and applies recursively all the way up an archetype lineage to the ultimate parent, which must be a top-level (non-specialised) archetype. For a top-level archetype, the flat-form is the same as its differential form (i.e. in a top-level archetype, every node is considered to be an extension node).</p>
</div>
</div>
<div class="sect2">
<h3 id="_specialisation_levels"><a class="anchor" href="#_specialisation_levels"></a><a class="link" href="#_specialisation_levels">Specialisation Levels</a></h3>
<div class="paragraph">
<p>In order to talk about archetypes at different levels of specialisation, a standard way of identifying the levels of specialisation is used, as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>level 0: top-level, non-specialised archetypes</p>
</li>
<li>
<p>level 1: specialisations of level 0 archetypes</p>
</li>
<li>
<p>level 2: specialisations of level 1 archetypes</p>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For nodes carrying a node identifier, the specialisation level is always equal to the number of '.' characters found in the identifier.</p>
</div>
</div>
<div class="sect2">
<h3 id="_specialisation_paths"><a class="anchor" href="#_specialisation_paths"></a><a class="link" href="#_specialisation_paths">Specialisation Paths</a></h3>
<div class="paragraph">
<p>Because ADL is a block-structured language, the redefinition of nodes deep in the parent structure normally requires descending into the structure. Since it is common to want to further constrain only nodes deep within a structure in specialised archetype, a more convenient way is provided in ADL to do this using a <em>specialisation path</em>, illustrated by the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    OBSERVATION[id1.1] ∈ {                                   -- Thyroid function tests
        /data[id2]/events[id3]/data[id4]/items ∈ {
                ELEMENT[id79.2] occurrences ∈ {0..1} ∈ {    -- TSH
                    value ∈ {
                        DV_QUANTITY[id0.7] ∈ { ... }
                    }
                }
                ELEMENT[id79.7] occurrences ∈ {0..1} ∈ {...} -- Free T3
                ...
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this fragment, a path is used rather than an attribute name. A path can be used in this manner only if no further constraints are required 'on the way' into the deep structure, with the exception of id-code overrides (since these can be syntactically accommodated within the path).</p>
</div>
<div class="paragraph">
<p>The rules for specialisation paths are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A specialisation path is constructed down to the first attribute having any child objects to be further constrained in the present archetype.</p>
</li>
<li>
<p>All path segments must carry an id-code predicate.</p>
</li>
<li>
<p>The shortest useful path that can be used is <code>/</code> followed by an attribute name from the top level class being constrained by the archetype.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_path_congruence"><a class="anchor" href="#_path_congruence"></a><a class="link" href="#_path_congruence">Path Congruence</a></h3>
<div class="paragraph">
<p>Any node in an archetype can unambiguously be located by its archetype path. For example, the text value of the 'problem' node of the <code>openEHR-EHR-EVALUATION.problem.v1</code> archetype shown at the top of the example in <a href="#redefinition_for_specialisation">Redefinition for Specialisation</a> is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    /data[id2]/items[id3]/value</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly the path to the redefined version of the same node in the <code>openEHR-EHR-EVALUATION.problem-diagnosis.v1</code> archetype at the bottom of the same figure is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    /data[id2]/items[id3.1]/value</code></pre>
</div>
</div>
<div class="paragraph">
<p>By inspection, it can be seen that this path is a variant of the corresponding path in the parent archetype, where a particular object node identifier has been specialised.</p>
</div>
<div class="paragraph">
<p>In general, the path of every redefined node in a specialised archetype will have a direct equivalent in the parent archetype, which can be determined by removing one level of specialisation from any node identifiers within the specialised path that are at the level of specialisation of the specialised archetype (i.e. node identifiers corresponding to higher specialisation levels are not changed). In this way, the nodes in a specialised archetype source can be connected to their counterparts in parent archetypes, for purposes of validation and flattening.</p>
</div>
<div class="paragraph">
<p>Conversely, any given path in an archetype that has children will have congruent paths in the children wherever nodes have been specialised.</p>
</div>
</div>
<div class="sect2">
<h3 id="_redefinition_concepts"><a class="anchor" href="#_redefinition_concepts"></a><a class="link" href="#_redefinition_concepts">Redefinition Concepts</a></h3>
<div class="paragraph">
<p>A specialised archetype definition at any level consists of a set of changes with respect to its flat parent. The technically available changes are categorised as follows.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Logical Intention</th>
<th class="tableblock halign-left valign-top">Physical Redefinition</th>
<th class="tableblock halign-left valign-top">Criteria</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock"><strong>Attibute node constraints</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANDATE an existing node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential attribute node refines existence to 1.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node has same attribute name as a node at the same path location in the flat parent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXCLUDE an existing node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential attribute node refines existence to 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node has same attribute name as a node at the same path location in the flat parent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REFINE an existing node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential attribute node refines cardinality of attribute at corresponding location in flat parent.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node has same attribute name as a node at the same path location in the flat parent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADD a new node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential attribute node will be added to parent object node at corresponding location in flat parent.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node does not exist in the flat parent, only in the Reference Model.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock"><strong>Object node constraints</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REFINE an existing node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential object node and sub-elements will OVERRIDE corresponding node, and some / all of its sub-elements from the flat parent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node has a specialised node identifier, and corresponding node in flat parent has max occurrences = 1 or else differential node is sole replacement and has max occurrences = 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SPECIALISE an existing node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential object node(s) and sub-elements will OVERRIDE a CLONE of the corresponding node, and some / all of its sub-elements from the flat parent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node has a specialised node identifier, and corresponding node in flat parent has max occurrences &gt; 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADD a new node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential object node(s) and sub-elements will be ADDed to container or single-valued attribute. In the case of a container, ordering can be controlled with the before/after constraint.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node has a specialised node identifier, and corresponding node in flat parent has max occurrences &gt; 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXCLUDE an existing node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential object node DELETEs existing node which has min occurrences = 0 (i.e. can&#8217;t delete a mandatory node).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node has same node identifier as corresponding node in parent, and occurrences = 0..0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FILL a slot.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External reference node will be added as slot filler next to corresponding slot from flat parent.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node is an external reference node, has specialised node identifier of a slot in the flat parent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLOSE a slot.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archetype slot node causes corresponding slot from flat parent to be closed to further filling.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential node is an archetype slot node, with same node identifier as a slot in the flat parent, and has the 'closed' flag set.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In the ADL syntax, objects can be specified in two places: under single-value attributes and under multiply-valued (container) attributes.</p>
</div>
<div class="paragraph">
<p>Each object under a single-valued attribute defines an alternative that may be used to constrain data at that attribute position. An example is the <code>OBSERVATION</code>.<code><em>protocol</em></code> attribute from the openEHR reference model: if multiple objects appear under this attribute, only one can be used at runtime to constrain data.</p>
</div>
<div class="paragraph">
<p>Within a container attribute, the meaning of multiple objects is that each child object defines constraints on one or more members of the container in the data. The <code>occurrences</code> constraint on each one determines how many objects in the data match a given object constraint in the attribute.</p>
</div>
<div class="paragraph">
<p>Object constraints can be specialised in both places by redefinition, refinement and exclusion. Addition can also be used under either kind of attribute: in both cases, it corresponds to an alternative. The actual semantics are described in terms of object node identification, type redefinition, and structural constraints (existence, cardinality and occurrences), and are the same for objects under single- and multiply-valued attributes. The following sections describe the details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples"><a class="anchor" href="#_examples"></a><a class="link" href="#_examples">Examples</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The examples below provide a basis for understanding most of the semantics discussed in the subsequent sections.</p>
</div>
<div class="sect2">
<h3 id="_redefinition_for_refinement"><a class="anchor" href="#_redefinition_for_refinement"></a><a class="link" href="#_redefinition_for_refinement">Redefinition for Refinement</a></h3>
<div class="paragraph">
<p>The example shown below is from an older version of the openEHR 'Problem' archetype and illustrates the use of redefinition and extension. The first text is the the definition section of the top-level 'Problem' archetype, and shows one <code>ELEMENT</code> node in expanded form, with the remaining nodes in an elided form.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    -- openEHR-EHR-EVALUATION.problem.v1 --

    EVALUATION[id1] ∈ {                                              -- Problem
        data ∈ {
            ITEM_TREE[id2] ∈ {
                items cardinality ∈ {0..*; ordered} ∈ {
                    ELEMENT[id3] occurrences ∈ {1} ∈ {
                        value ∈ {
                            DV_TEXT[id4]                             -- *** NODE A
                        }
                    }
                    ELEMENT[id5] occurrences ∈ {0..1} ∈ {...}       -- Date of initial onset
                    ELEMENT[id6] occurrences ∈ {0..1} ∈ {...}       -- Age at initial onset
                    ELEMENT[id7] occurrences ∈ {0..1} ∈ {...}       -- Severity
                    ELEMENT[id8] occurrences ∈ {0..1} ∈ {...}       -- Clinical description
                    ELEMENT[id10] occurrences ∈ {0..1} ∈ {...}      -- Date clinically received
                    CLUSTER[id11] occurrences ∈ {0..1} ∈ {...}      -- Location
                    CLUSTER[id14] occurrences ∈ {0..1} ∈ {...}      -- Aetiology
                    -- etc
                }
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second text below is from the 'problem-diagnosis' archetype, i.e. a 'diagnosis' specialisation of the general notion of 'problem'. In this situation, the node <code>[id2]</code>, with occurrences of 1, i.e. mandatory non-multiple, has its meaning narrowed to <code>[id2.1]</code> 'diagnosis' (diagnosed problems are seen as a subset of all problems in medicine), while new sibling nodes are added to the items attribute to define details particular to recording a diagnosis. The extension nodes are identified by the codes <code>[at0.32]</code> , <code>[at0.35]</code> and <code>[at0.37]</code>, with the latter two shown in elided form.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    -- openEHR-EHR-EVALUATION.problem-diagnosis.v1 --   -- specialises openEHR-EHR-EVALUATION.problem.v1

    EVALUATION[id1.1] ∈ {                               -- Recording of diagnosis
        /data[id2.1]/items[id3]/value ∈ {               -- redefine id2 to id2.1 (in terminology section)
            DV_CODED_TEXT[id4] ∈ {                      -- &lt;&lt; This node redefines 'NODE A' above
                defining_code ∈ {[ac0.1]}
            }
        }
        /data/items cardinality ∈ {0..*; ordered} ∈ {
            before [id5]
            ELEMENT[id0.32] occurrences ∈ {0..1} ∈ {    -- Status    ++ This node added
                value ∈ {
                    DV_CODED_TEXT[id0.33] ∈ {
                        defining_code ∈ {
                            [local::at0.33, at0.34]      -- provisional
                        }
                    }
                }
            }
            after [id31]
            CLUSTER[id0.35] occurrences ∈ {0..1} ∈ {...}  -- Diag. criteria  ++ This node added
            CLUSTER[id0.37] occurrences ∈ {0..1} ∈ {...}  -- Clin. staging   ++ This node added
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="redefinition_for_specialisation"><a class="anchor" href="#redefinition_for_specialisation"></a><a class="link" href="#redefinition_for_specialisation">Redefinition for Specialisation</a></h3>
<div class="paragraph">
<p>The example shown below illustrates redefinition in a specialised archetype. The first text is taken from the definition section of the 'laboratory result' <code>OBSERVATION</code> archetype (available at <a href="https://www.openehr.org/ckm">openEHR CKM</a>), and contains an <code>ELEMENT</code> node whose identifier is <code>[id79]</code> , defined as 'panel item' in the archetype terminology (sibling nodes are not shown here). The intention is that the <code>id79</code> node be specialised into particular 'panel items' or analytes according to particular types of test result. Accordingly, the <code>id79</code> node has occurrences of <code>0..*</code> and its value is not constrained with respect to the reference model, meaning that the type of the <code><em>value</em></code> attribute can be any descendant of <code>DATA_VALUE</code> .</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ------ openEHR-EHR-OBSERVATION.laboratory.v1 ------
    OBSERVATION[id1] ∈ {                                                       -- Laboratory Result
        data ∈ {
            HISTORY[id2] ∈ {
                events ∈ {
                    EVENT[id3] ∈ {                                             -- Any event
                        data ∈ {
                            ITEM_TREE[id4] ∈ {
                                items cardinality ∈ {0..*; unordered} ∈ {
                                    CLUSTER[id5] occurrences ∈ {1} ∈ {...}      -- Specimen
                                    ELEMENT[id8] occurrences ∈ {0..1} ∈ {...}   -- Diagnostic services
                                    CLUSTER[id11] occurrences ∈ {0..*} ∈ {...}  -- level 1
                                    ELEMENT[id79] occurrences ∈ {0..*}          -- panel item
                                    ELEMENT[id17] occurrences ∈ {0..1} ∈ {...}  -- Overall Comment
                                    CLUSTER[id18] occurrences ∈ {0..1} ∈ {...}  -- Quality
                                    ELEMENT[id37] occurrences ∈ {0..1} ∈ {...}  -- Multimedia rep.
                                }
                            }
                        }
                    }
                }
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second text, below, is a specialised version of the laboratory result archetype, defining 'thyroid function test result'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ------ openEHR-EHR-OBSERVATION.laboratory-thyroid.v1 ------
    OBSERVATION[id1.1] -- Thyroid function tests
        /data[id2]/events[id3]/data[id4]/items ∈ {
            ELEMENT[id79.1] occurrences ∈ {0..1} ∈ {        -- TSH
                value ∈ {
                    DV_QUANTITY[id0.7] ∈ {
                        property ∈ {[at15]}
                        magnitude ∈ {|0.0..100.0|}
                        units ∈ {"mIU/l"}
                    }
                }
            }
            ELEMENT[id79.2] occurrences ∈ {0..1} ∈ {...}    -- Free Triiodothyronine (Free T3)
            ELEMENT[id79.3] occurrences ∈ {0..1} ∈ {...}    -- Total Triiodothyronine (Total T3)
            ELEMENT[id79.4] occurrences ∈ {0..1} ∈ {...}    -- Free thyroxine (Free T4)
            ELEMENT[id79.5] occurrences ∈ {0..1} ∈ {...}    -- Total Thyroxine (Total T4)
            ELEMENT[id79.6] occurrences ∈ {0..1} ∈ {...}    -- T4 loaded uptake
            ELEMENT[id79.7] occurrences ∈ {0..1} ∈ {...}    -- Free Triiodothyronine index (Free T3 index)
            ELEMENT[id79.8] occurrences ∈ {0..1} ∈ {...}    -- Free thyroxine index (FTI)
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The redefinitions include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a redefinition of the top-level object node identifier <code>[id1]</code> , with the specialised node identifier <code>[id1.1]</code>;</p>
</li>
<li>
<p>eight nodes redefining the <code>[id79]</code> node are shown, with overridden node identifiers <code>[id79.1]</code> - <code>[id79.8]</code>;</p>
</li>
<li>
<p>reduced occurrences (<code>0..1</code> in each case);</p>
</li>
<li>
<p>redefinition of the <code><em>value</em></code> attribute of each <code>ELEMENT</code> type to <code>DV_QUANTITY</code>, shown in expanded form for node <code>[id79.1]</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the original <code>ELEMENT[id79]</code> node with <code>occurrences</code> of <code>0..*</code> remains a valid constraint node: the fact of specialisation does not remove it. If the intention is that the specialised nodes constitute an <em>exhaustive</em> redefinition of the original node, the latter can be effectively removed, as described in <a href="#_exhaustive_and_non_exhaustive_redefinition">Exhaustive and Non-Exhaustive Redefinition</a>.</p>
</div>
<div class="paragraph">
<p>This archetype is typical of a class of specialisations that use only redefinition, due to the fact that all objects in the redefined part of the specialised version are semantically specific kinds of a general object, in this case, 'panel item'.</p>
</div>
<div class="sect3">
<h4 id="_specialisation_with_cloning"><a class="anchor" href="#_specialisation_with_cloning"></a><a class="link" href="#_specialisation_with_cloning">Specialisation with Cloning</a></h4>
<div class="paragraph">
<p>In the previous example, each of the nodes with identifiers of the form <code>id79.N</code> would be effectively copied to the flat output, since the node being redefined (<code>id79</code>) has no sub-structure, i.e. it is a 'matches any' node. However, the general case is that the node in the parent has its own structure, typically some boilerplate nodes that would be used by any specialisation. In that case, an archetype containing nodes that specialise a node with existing structure cause a 'clone and overlay' operation. That is, to generate the flat output of the specialised archetype, the parent node is first cloned from the flat parent to the new flat output, and then the specialised node is overlaid on the cloned structure. The following example shows a parent archetype that defines a 'laboratory result' structure as a <code>CLUSTER</code> containing a number of <code>ELEMENT</code> objects, defining things like Result value, Reference range guidance and so on. The <code>id2</code> Result value node is intended to be specialised.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    CLUSTER[id1] ∈ {                                         -- Laboratory test panel
        items ∈ {
            CLUSTER[id3] ∈ {                                 -- Laboratory Result
                items ∈ {
                    ELEMENT[id2] occurrences ∈ {0..1}        -- Result Value
                    ELEMENT[id4] ∈ {                         -- Result Comment
                        value ∈ {
                            DV_TEXT[id15]
                        }
                    }
                    ELEMENT[id5] occurrences ∈ {0..1} ∈ {   -- Ref. Range Guidance
                        value ∈ {
                            DV_TEXT[id16]
                        }
                    }
                    ELEMENT[id6] occurrences ∈ {0..1} ∈ {   -- Result Value Status
                        value ∈ {
                            DV_CODED_TEXT[id17] ∈ {
                                defining_code ∈ {[ac1]}
                            }
                        }
                    }
                    ELEMENT[id7] occurrences ∈ {0..1} ∈ {   -- D/T Result Val Status
                        value ∈ {
                            DV_DATE_TIME[id18]
                        }
                    }
                }
            }
            allow_archetype CLUSTER[id14] ∈ {                -- Other Detail
                include
                    archetype_id/value ∈ {/.*/}
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specialised child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    CLUSTER[id1.1] ∈ {    -- Lipid studies panel
        /items ∈ {
            CLUSTER[id3.1] ∈ {    -- LDL Cholesterol Result
                items ∈ {
                    ELEMENT[id2.1] ∈ {    -- LDL Cholesterol
                        value ∈ {
                            DV_QUANTITY[id0.1] ∈ {
                                property ∈ {[at0.1]}
                                magnitude ∈ {|&gt;=0.0|}
                                units ∈ {"mmol/l"}
                            }
                        }
                    }
                }
            }
            CLUSTER[id3.2] ∈ {    -- HDL Cholesterol Result
                items ∈ {
                    ELEMENT[id2.2] ∈ {    -- HDL Cholesterol
                        value ∈ {
                            DV_QUANTITY[id0.2] ∈ {
                                property ∈ {[at0.1]}
                                magnitude ∈ {|&gt;=0.0|}
                                units ∈ {"mmol/l"}
                            }
                        }
                    }
                }
            }
            CLUSTER[id3.3] ∈ {...}    -- Ratio Result
            CLUSTER[id3.4] ∈ {...}    -- Triglyceride Result
            CLUSTER[id3.5] ∈ {        -- Total Result
                items ∈ {
                    ELEMENT[id2.5] ∈ {    -- Total cholesterol
                        value ∈ {
                            DV_QUANTITY[id0.5] ∈ {
                                property ∈ {[at0.1]}
                                magnitude ∈ {|&gt;=0.0|}
                                units ∈ {"mosmol/l"}
                            }
                        }
                    }
                }
            }
            CLUSTER[id3.6]     -- ! - Laboratory Result
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The flattened result consists of a number of repetitions of the entire <code>CLUSTER[id3]</code> structure from the parent, corresponding to the specialisations in the child. The ADL source form is too large to show here, but the <a href="https://www.openehr.org/downloads/ADLworkbench">ADL Workbench</a> provides a visualisation in <a href="#specialisation_with_cloning">Specialisation with Cloning</a>. In this figure we can see that the <code>CLUSTER</code> / <code>ELEMENT</code> overlays from the child archetype have been overlaid on clones of the <code>CLUSTER[id3]</code> structure from the parent, preserving the <code>id4</code> , <code>id5</code> etc nodes. Elements shown in light blue are inherited; where they appear under the nodes <code>[id3.1]</code>, <code>[id3.2]</code> etc, they are cloned from the corresponding nodes under <code>[id3]</code>.</p>
</div>
<div id="specialisation_with_cloning" class="imageblock text-center unresolved text-center">
<div class="content">
<img src="{images_uri}/specialisation_with_cloning.png" alt="specialisation with cloning" width="75%">
</div>
<div class="title">Figure 1. Specialisation with Cloning</div>
</div>
<div class="paragraph">
<p>It can also be seen that the original <code>[id3]</code> sub-tree remains. This can be removed if required, as described in <a href="#_exhaustive_and_non_exhaustive_redefinition">Exhaustive and Non-Exhaustive Redefinition</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_attribute_redefinition"><a class="anchor" href="#_attribute_redefinition"></a><a class="link" href="#_attribute_redefinition">Attribute Redefinition</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A small number of things can be redefined on attributes, including existence and cardinality. A basic rule of redefinition is that a specialised archetype cannot change the multiplicity type of an attribute.</p>
</div>
<div class="sect2">
<h3 id="_existence_redefinition_mandation_and_exclusion"><a class="anchor" href="#_existence_redefinition_mandation_and_exclusion"></a><a class="link" href="#_existence_redefinition_mandation_and_exclusion">Existence Redefinition: Mandation and Exclusion</a></h3>
<div class="paragraph">
<p>All attributes mentioned in an archetype have an <em>existence</em> constraint, indicating whether a value is required or not. The constraint is either stated explicitly - typically done for single-valued attributes - or it is the value from the reference model - typical for multiply-valued attributes. In both cases, the existence of an attribute in a parent archetype can be redefined in a specialised archetype using the standard cADL syntax. In the following example, an implicit existence constraint picked up from the reference model of <code>{0..1}</code> is redefined in a child archetype to <code>{1}</code> , i.e. mandatory.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    OBSERVATION[id1] ∈ {                -- blood pressure measurement
        protocol ∈ {                    -- existence not changed from reference model
            -- etc
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    OBSERVATION[id1.1] ∈ {              -- paediatric blood pressure measurement
        /protocol existence ∈ {1} ∈ {
            -- etc
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Redefinition of existence to ` {0}` by this method denotes exclusion, i.e. removal of the entire attribute (including all sub-structure) from the resulting structure. In an archetype, it is likely to indicate poor design, given that the decision to remove optional attributes is much more likely to be local, and therefore more appropriate in templates rather than archetypes; within a template it would be perfectly normal. The following example shows the protocol attribute in the above ` OBSERVATION` archetype being excluded in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">   OBSERVATION[id1] ∈ {                -- paediatric blood pressure measurement
        /protocol existence ∈ {0}
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in the above, the '/' is used to denote '/protocol' as a differential path. Without the slash, the 'protocol' attribute would be considered to be trying to constrain a hitherto unconstrained attribute called 'protocol', rather than redefine a constraint already present in a parent archetype.</p>
</div>
</div>
<div class="sect2">
<h3 id="_multiply_valued_container_attributes"><a class="anchor" href="#_multiply_valued_container_attributes"></a><a class="link" href="#_multiply_valued_container_attributes">Multiply-valued (Container) Attributes</a></h3>
<div class="paragraph">
<p>The following sub-sections describe specialisation semantics specific to container attributes.</p>
</div>
<div class="sect3">
<h4 id="_cardinality"><a class="anchor" href="#_cardinality"></a><a class="link" href="#_cardinality">Cardinality</a></h4>
<div class="paragraph">
<p>The <em>cardinality</em> constraint defines how many object instances can be in the container within the data (not the archetype). In a specialised archetype, cardinality can be redefined to be a narrower range than in the parent, further limiting the valid ranges of items in the data that may occur within the container. This would normally only make sense if refinements were made to the occurrences of the contained items, i.e.:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>narrowing the occurrences range of an object;</p>
</li>
<li>
<p>excluding an object by setting its occurrences to {0};</p>
</li>
<li>
<p>adding new objects, which themselves will have occurrences constraints;</p>
</li>
<li>
<p>setting some object occurrences to mandatory, and the enclosing cardinality lower limit to some non-zero value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As long as the relationship between the enclosing attribute&#8217;s cardinality constraint and the occurrences constraints defined on all the contained items (including those inherited unchanged, and therefore not mentioned in the specialised archetype) is respected (see VCOC validity rule, AOM specification), any of the above specialisations can occur.</p>
</div>
<div class="paragraph">
<p>The following provides an example of cardinality redefinition.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ITEM_LIST[id3] ∈ {                                      -- general check list
        items cardinality ∈ {0..*} ∈ {                      -- any number of items
            ELEMENT[id12] occurrences ∈ {0..*} ∈ {...}      -- generic checklist item
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ITEM_LIST[id3] ∈ {                                      -- pre-operative check list
        /items cardinality ∈ {3..10} ∈ {                    -- at least 3 mandatory items
            ELEMENT[id12.1] occurrences ∈ {1} ∈ {...}       -- item #1
            ELEMENT[id12.2] occurrences ∈ {1} ∈ {...}       -- item #2
            ELEMENT[id12.3] occurrences ∈ {1} ∈ {...}       -- item #3
            ELEMENT[id12.4] occurrences ∈ {0..1} ∈ {...}    -- item #4
            ...
            ELEMENT[id12.10] occurrences ∈ {0..1} ∈ {...}   -- item #10
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ordering_of_sibling_nodes"><a class="anchor" href="#_ordering_of_sibling_nodes"></a><a class="link" href="#_ordering_of_sibling_nodes">Ordering of Sibling Nodes</a></h4>
<div class="paragraph">
<p>Within container attributes, the order of objects may be significant from the point of view of domain users, i.e. the container may be considered as an ordered list. This is easy to achieve in top-level archetype, using the 'ordered' qualifier on a cardinality constraint. However when particular node(s) are redefined into multiple specialised nodes, or new nodes added by extension, the desired order of the new nodes may be such that they should occur interspersed at particular locations among nodes defined in the parent archetype. The following text is a slightly summarised view of the items attribute from the problem archetype shown in <a href="#redefinition_for_specialisation">Redefinition for Specialisation</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    items cardinality ∈ {0..*; ordered} ∈ {
        ELEMENT[id2] occurrences ∈ {1} ∈ {...}               -- Problem
        ELEMENT[id3] occurrences ∈ {0..1} ∈ {...}            -- Date of initial onset
        ELEMENT[id4] occurrences ∈ {0..1} ∈ {...}            -- Age at initial onset
        ELEMENT[id5] occurrences ∈ {0..1} ∈ {...}            -- Severity
        ELEMENT[id9] occurrences ∈ {0..1} ∈ {...}            -- Clinical description
        ELEMENT[id10] occurrences ∈ {0..1} ∈ {...}           -- Date clinically received
        CLUSTER[id11] occurrences ∈ {0..*} ∈ {...}           -- Location
        CLUSTER[id14] occurrences ∈ {0..1} ∈ {...}           -- Aetiology
        CLUSTER[id18] occurrences ∈ {0..1} ∈ {...}           -- Occurrences or exacerb'ns
        CLUSTER[id26] occurrences ∈ {0..1} ∈ {...}           -- Related problems
        ELEMENT[id30] occurrences ∈ {0..1} ∈ {...}           -- Date of resolution
        ELEMENT[id31] occurrences ∈ {0..1} ∈ {...}           -- Age at resolution
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To indicate significant ordering in the specialised problem-diagnosis archetype, the keywords ` before` and ` after` can be used, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    /data[id3]/items ∈ {
        before [id3]
        ELEMENT[id2.1] ∈ {...}                                -- Diagnosis
        ELEMENT[id0.32] occurrences ∈ {0..1} ∈ {...}          -- Status
        after [id26]
        CLUSTER[id0.35] occurrences ∈ {0..1} ∈ {...}          -- Diagnostic criteria
        CLUSTER[id0.37] occurrences ∈ {0..1} ∈ {...}          -- Clinical Staging
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>These keywords are followed by a node identifier reference, and act to anchor the location of the node definitions immediately following until the next sibling order marker or the end of the list. The following visual rendition is equivalent, but arguably less readable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    after [id26] CLUSTER[id0.35] occurrences ∈ {0..1} ∈ {...}  -- etc</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rules for specifying ordering are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ordering is only applicable to object nodes defined within a multiply-valued (i.e. container) attribute whose cardinality includes the <code>ordered</code> constraint;</p>
</li>
<li>
<p>Any <code>before</code> or <code>after</code> statement can use as its anchor the node identifier of any sibling node from the same container attribute in the flat form of the parent archetype, or a redefined version of the same, local to the current archetype;</p>
</li>
<li>
<p>If no sibling order markers are used, redefined nodes should appear in the same position as the nodes they replace, while extension nodes appear at the end.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If ordering indicators are used in an archetype that is itself further specialised, the following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the referenced identifier becomes unavailable due to being redefined in the new archetype, it must be redefined to refer to an available sibling identifier as per the rules above.</p>
</li>
<li>
<p>If this does not occur, a <code>before</code> reference will default to the first sibling node identifier currently available conforming to the original identifier, while an <code>after</code> reference will default to the <em>last</em> such identifier available in the current flat archetype.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If, due to multiple levels of redefinition, there is more than one candidate to go before (or after) a given node, the compiler should output a warning. The problem would be resolved by the choice of one of the candidates being changed to indicate that it is to be ordered before (after) another of the candidates rather than the originally stated node.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_object_redefinition"><a class="anchor" href="#_object_redefinition"></a><a class="link" href="#_object_redefinition">Object Redefinition</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Object redefinition can occur for any object constraint in the parent archeype, and can include redefinition of node identifier, occurrences, reference model type. For certain kinds of object constraints, specific kinds of redefinition are possible.</p>
</div>
<div class="sect2">
<h3 id="_node_identifiers"><a class="anchor" href="#_node_identifiers"></a><a class="link" href="#_node_identifiers">Node Identifiers</a></h3>
<div class="paragraph">
<p>In an archetype, node identifiers ('id-codes') are mandatory on all object constraint nodes. The identifiers of those object nodes defined as children of a multiply-valued attribute and multiple alternative children of single-valued attributes (see <a href="#_node_identifiers">Node Identifiers</a>) require definitions in the archetype terminology. Definitions are optional on other single child constraints of single-valued attributes. This rule applies in specialised as well as top-level archetypes.</p>
</div>
<div class="paragraph">
<p>A key question is: when does a node identifier need to be redefined? There are three possible situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when the node is the root node of an archetype, the meaning is always considered to be redefined;</p>
</li>
<li>
<p>it can be redefined for purely semantic purposes on other nodes, e.g. to redefine 'heart rate' to 'fetal heart rate';</p>
</li>
<li>
<p>a node identifier must be redefined if the node is being redefined into multiple child nodes, either under a multiply-valued attribute, or as alternatives under a single-valued attribute.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Redefinition of an object node identifier for purely semantic purposes, unaccompanied by any other kind of constraint change is done as shown in the following example.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    EVALUATION[id1] ∈ {                                      -- Medical Certificate
        data ∈ {
            ITEM_TREE[id2] ∈ {
                items ∈ {
                    ELEMENT[id5] occurrences ∈ {0..1} ∈ {   -- Description
                        value ∈ {
                            DV_TEXT[id7]
                        }
                    }
                }
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    EVALUATION[id1.1] ∈ {                              -- Singapore Medical Certificate
        /data[id2]/items ∈ {
            ELEMENT[id5.1]                             -- Summary
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the <code>id5</code> ('Description') node is refined in meaning to <code>id5.1</code> ('Summary'). Since there is no other constraint to be stated, no further <code>matches</code> block is required.</p>
</div>
<div class="paragraph">
<p>An example of the 3rd case above of redefinition is shown in the first archetype in <a href="#redefinition_for_specialisation">Redefinition for Specialisation</a>, where the node <code>[id79]</code> is redefined into a number of more specialised nodes <code>[id79.2]</code> - <code>[id79.9]</code>, while in the second, the identifier <code>[id2]</code> is redefined to a single node <code>[id2.1]</code> .</p>
</div>
<div class="paragraph">
<p>The syntactic form of the identifier of a redefined node is a copy of the original followed by a dot ('.'), optionally intervening instances of the pattern '0.' and then a further non-zero number, i.e.:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>idN {.0}* .N</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This permits node identifiers from a given level to be redefined not just at the next level, but at multiple levels below.</p>
</div>
<div class="paragraph">
<p>The following are examples of redefined node identifiers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id2.1</code>  : redefinition of <code>id2</code> at level 1 specialisation;</p>
</li>
<li>
<p><code>id2.0.1</code>: redefinition of <code>id2</code> node in level 2 specialisation archetype;</p>
</li>
<li>
<p><code>id2.1.1</code>: redefinition of <code>id2.1</code> in level 2 specialisation archetype.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The digits '1' and '2' here should not be confused with levels 1 and 2. The above identifiers based on an <code>id6</code> node might easily be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id6.7</code>  : redefinition of <code>id6</code> in a level 1 specialisation archetype;</p>
</li>
<li>
<p><code>id6.0.8</code>: redefinition of <code>id6</code> node in a level 2 specialisation archetype;</p>
</li>
<li>
<p><code>id6.7.8</code>: redefinition of <code>id6.7</code> in a level 2 specialisation archetype.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_adding_nodes"><a class="anchor" href="#_adding_nodes"></a><a class="link" href="#_adding_nodes">Adding Nodes</a></h4>
<div class="paragraph">
<p>Added object constraint nodes carry identifiers according to the rule mentioned above. The second example includes the new node identifiers <code>id0.32</code> , <code>id0.35</code> and <code>id0.37</code> , whose codes start with a '0'. indicating that they have no equivalent code in the parent archetype.</p>
</div>
<div class="paragraph">
<p>The node identifier syntax of an extension node commences with at least one instance of the pattern '0.'. The structure of node identifiers for both kinds of node thus always indicates at what level the identifier was introduced, given by the number of dots.</p>
</div>
<div class="paragraph">
<p>Examples of added node identifiers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id0.1</code>  : identifier of extension node introduced at level 1;</p>
</li>
<li>
<p><code>id0.0.1</code>: identifier of extension node introduced at level 2.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a flat form is created, the level at which any given node was introduced or redefined is clear due to the identifier coding system.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_occurrences_redefinition_and_exclusion"><a class="anchor" href="#_occurrences_redefinition_and_exclusion"></a><a class="link" href="#_occurrences_redefinition_and_exclusion">Occurrences Redefinition and Exclusion</a></h3>
<div class="paragraph">
<p>The <code>occurrences</code> constraint on an object node indicates how many instances within the data may conform to that constraint (see <a href="#Container Attributes">[Container Attributes]</a>). Within container attributes, <code>occurrences</code> is usually redefined in order to make a given object mandatory rather than optional; it can also be used to exclude an object constraint. In the following example, the occurrences of the <code>id4</code> node is redefined from <code>{0..1}</code> i.e. optional, to <code>{1}</code> , i.e. mandatory.</p>
</div>
<div class="paragraph">
<p>Parent (<code>openEHR-EHR-EVALUATION.problem.v1.0.3</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    EVALUATION[id1] ∈ { -- Problem
        data ∈ {
            ITEM_TREE[id2] ∈ {
                items cardinality ∈ {0..*; ordered} ∈ {
                    ELEMENT[id3] occurrences ∈ {1} ∈ {...}       -- Problem
                    ELEMENT[id4] occurrences ∈ {0..1} ∈ {...}    -- Date of initial onset
                    -- etc
                }
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Child (<code>openEHR-EHR-EVALUATION.problem-diagnosis.v1</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    /data[id2]/items ∈ {
        ELEMENT[id4] occurrences ∈ {1}  -- Date of initial onset
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above we can see that if the only change in the redefinition is to occurrences, the remainder of the block from the parent is not repeated in the child. Occurrences is normally only constrained on child objects of container attributes, but can be set on objects of any attribute to effect exclusion of part of the instance space. This can be useful in archetypes where a number of alternatives for a single-valued attribute have been stated, and the need is to remove some alternatives in a specialised child archetype. For example, an archetype might have the following constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ELEMENT[id3] ∈ {
        value ∈ {
            DV_QUANTITY[id4] ∈ {...}
            DV_INTERVAL&lt;DV_QUANTITY&gt;[id5] ∈ {...}
            DV_COUNT[id6] ∈ {...}
            DV_INTERVAL&lt;DV_COUNT&gt;[id7] ∈ {...}
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the intention is to remove the <code>DV_INTERVAL&lt;*&gt;</code> alternatives. This is achieved by redefining the enclosing object to removed the relevant types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ELEMENT[id3] ∈ {
        value ∈ {
            DV_INTERVAL&lt;DV_QUANTITY&gt;[id4] occurrences ∈ {0}
            DV_INTERVAL&lt;DV_COUNT&gt;[id7] occurrences ∈ {0}
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exclusion by setting occurrences to <code>{0}</code> is also common in templates, and is used to remove specific child objects of container attributes, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    /data[id2]/items ∈ {
        CLUSTER[id26] occurrences ∈ {0}     -- remove 'Related problems'
        ELEMENT[id31] occurrences ∈ {0}     -- remove 'Age at resolution'
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the whole attribute is to be removed, this can be done by redefining existence to <code>{0}</code>, as described in <a href="#_existence_redefinition_mandation_and_exclusion">Existence Redefinition: Mandation and Exclusion</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_single_and_multiple_specialisation_when_does_cloning_occur"><a class="anchor" href="#_single_and_multiple_specialisation_when_does_cloning_occur"></a><a class="link" href="#_single_and_multiple_specialisation_when_does_cloning_occur">Single and Multiple Specialisation - When does Cloning Occur?</a></h3>
<div class="paragraph">
<p>In the <a href="#_examples">examples shown above</a> there are two types of redefinition occurring. The first shows a single node in the parent archetype redefined by a single node, both identified by <code>id4</code>. The second shows a single node in the parent redefined by multiple children. In the first example, the result of flattening is <em>in-place overlaying</em>, while in the second, it is <em>cloning with overlaying</em>. The consequence of the second type of redefinition is that the original parent node survives in its original form in the child archetype, whereas in the first, it is replaced. The reasoning behind this is that redefinition to multiple children is taken to mean that later redefinition to multiple children may occur in deeper child archetypes, and for this to occur, the original parent needs to be left intact. Conversely, the single-parent / single-child redefinition is taken to mean a logical refinement of an existing node, which should therefore be logically replaced.</p>
</div>
<div class="paragraph">
<p>The formal rule for whether cloning occurs or not is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    clone not needed = max effective_occurrences of object node in parent archetype = 1 OR
        object node in child differential archetype is sole child of its parent, and has max occurrences = 1</pre>
</div>
</div>
<div class="paragraph">
<p>The first case corresponds to the situation where the 'effective occurrences' of any child of an attribute can be inferred to be maximum 1, i.e. either the attribute is single-valued, or it is a container with a cardinality constraint with maximum 1. The second is where the object in the child archetype has an explicit occurrences constraint of max 1. In the above, the <code><em>effective_occurrences</em></code> function is defined in the <a href="https://specifications.openehr.org/releases/AM/latest/AOM2.html#_occurrences_inferencing_rules">AOM2 specification</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exhaustive_and_non_exhaustive_redefinition"><a class="anchor" href="#_exhaustive_and_non_exhaustive_redefinition"></a><a class="link" href="#_exhaustive_and_non_exhaustive_redefinition">Exhaustive and Non-Exhaustive Redefinition</a></h3>
<div class="paragraph">
<p>In any multiple specialisation situation, there is a question of whether the original node being specialised (e.g. <code>id79</code> and <code>id2</code> in the examples above) remains available for further redefinition in subsequent child archetypes, or do the redefinition children <em>exhaustively</em> define the instance space for the given parent node?</p>
</div>
<div class="paragraph">
<p>Should these children be considered exhaustive? One point of view says so, since all subsequently discovered varieties of hepatitis (C, D, E, etc) would now become children of 'hepatitis non-A non-B'. However this is likely to be sub-optimal, since now the category 'hepatitis non-A non-B' probably exists solely because of the order in which the various hepatitis virus tests were perfected. Therefore an alternative argument would say that the categories 'hepatitis C', 'hepatitis D' etc should be defined directly below 'hepatitis', as if 'hepatitis non-A non-B' had never existed. Under this argument, the children would not be declared, even when they are theoretically exhaustive.</p>
</div>
<div class="paragraph">
<p>This kind of argument comes up time and again, and the need for catch-all categories (archetype nodes) and the possibility of future discoveries cannot be predicted. Even in situations such as a lab result (e.g. cholesterol), where the list of analytes seem to be known and fixed, experience of clinical modellers has shown that there is nevertheless no guarantee of not needing another data point, perhaps for something other than an analyte.</p>
</div>
<div class="paragraph">
<p>The default situation is that child redefinition nodes do not exhaustively replace the parent unless explicitly stated otherwise. This may be done by excluding the parent node in the normal way, i.e. using <code>occurrences matches {0}</code>. <strong>If an exclusion node is included, it must come last</strong> in the set of siblings that specialise the parent node, otherwise a deletion will occur, leaving no node to specialise. The first example would then become:</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    items cardinality ∈ {0..*; unordered} ∈ {
        CLUSTER[id4] occurrences ∈ {1} ∈ {...}                          -- Specimen
        CLUSTER[id11] occurrences ∈ {0..*} ∈ {...}                      -- level 1
        ELEMENT[id79] occurrences ∈ {0..*} ∈ {                          -- panel item
            value ∈ {*}
        }
        ELEMENT[id17] occurrences ∈ {0..1} ∈ {...}                      -- Overall Comment
        ELEMENT[id37] occurrences ∈ {0..1} ∈ {...}                      -- Multimedia rep.
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    /data/events[id2]/data/items ∈ {
        ELEMENT[id79.1] occurrences ∈ {0..1} ∈ {...}                    -- TSH
        ELEMENT[id79.2] occurrences ∈ {0..1} ∈ {...}                    -- Free Triiodothyronine
        ELEMENT[id79.3] occurrences ∈ {0..1} ∈ {...}                    -- Total Triiodothyronine
        ELEMENT[id79.4] occurrences ∈ {0..1} ∈ {...}                    -- Free thyroxine (Free T4)
        ELEMENT[id79.5] occurrences ∈ {0..1} ∈ {...}                    -- Total Thyroxine (Total T4)
        ELEMENT[id79.6] occurrences ∈ {0..1} ∈ {...}                    -- T4 loaded uptake
        ELEMENT[id79.7] occurrences ∈ {0..1} ∈ {...}                    -- Free Triiodothyronine index
        ELEMENT[id79.8] occurrences ∈ {0..1} ∈ {...}                    -- Free thyroxine index (FTI)
        ELEMENT[id79] occurrences ∈ {0}                                  -- MUST COME LAST!
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without the above specification, a deeper child archetype could then redefine both the original <code>id79</code> node (e.g. into <code>id79.0.1</code> , <code>id79.0.2</code>), and any of the <code>id79.x</code> nodes (e.g. <code>id79.1.1</code> , <code>id79.1.2</code>); with it, only the latter is possible. The <code>id79</code> node can thus be considered to be logically 'frozen', in a similar way to frozen class methods in some programming languages.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reference_model_type_refinement"><a class="anchor" href="#_reference_model_type_refinement"></a><a class="link" href="#_reference_model_type_refinement">Reference Model Type Refinement</a></h3>
<div class="paragraph">
<p>The type of an object may be redefined to one of its subtypes as defined by the reference model. A typical example of where this occurs in archetypes based on the openEHR reference model is when <code>ELEMENT.<em>value</em></code> is constrained to <code>*</code> in a parent archetype, meaning 'no further constraint on its RM type of <code>DATA_VALUE</code>, but is then constrained in a specialised archetype to subtypes of <code>DATA_VALUE</code>, e.g. <code>DV_QUANTITY</code> or <code>DV_PROPORTION</code> (see <a href="https://specifications.openehr.org/releases/RM/latest/data_types.html">openEHR Data Types</a>). The following figure containts a simplified extract of the data values part of the openEHR reference model, and is the basis for the examples below.</p>
</div>
<div id="rm_type_structure" class="imageblock text-center text-center">
<div class="content">
<img src="../_images/diagrams/RM-data_types-overview.svg" alt="RM data types overview" width="50%">
</div>
<div class="title">Figure 2. Example Reference Model type structure</div>
</div>
<div class="paragraph">
<p>The most basic form of type refinement is shown in the following example:</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    value ∈ {*} -- any subtype of DATA_VALUE, from the ref model</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specialised archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    .../value ∈ {
        DV_QUANTITY[id8] -- now limit to the DV_QUANTITY subtype
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The meaning of the above is that instance data constrained by the specialised archetype at the value node must match the <code>DV_QUANTITY</code> constraint only - no other subtype of <code>DATA_VALUE</code> is allowed.</p>
</div>
<div class="paragraph">
<p>When a type in an archetype is redefined into one of its subtypes, any existing constraints on the original type in the parent archetype are respected. In the following example, a <code>DV_AMOUNT</code> constraint that required <em>accuracy</em> to be present and in the range +/-5% is refined into a <code>DV_QUANTITY</code> in which two attributes of the subtype are constrained. The original <em>accuracy</em> attribute is inherited without change.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    value ∈ {
        DV_AMOUNT[id4] ∈ {
            accuracy ∈ {|-0.05..0.05|}
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specialised archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    .../value ∈ {
        DV_QUANTITY[id4] ∈ {
            magnitude ∈ {|2.0..10.0|}
            units ∈ {"mmol/ml"}
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the same manner, an object node can be specialised into more than one subtype, where each such constraint selects a mutually exclusive subset of the instance space. The following example shows a specialisation of the <code>DV_AMOUNT</code> constraint above into two subtyped constraints.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    .../value ∈ {
        DV_QUANTITY[id4.1] ∈ {
            magnitude ∈ {|2.0..10.0|}
            units ∈ {"mmol/ml"}
        }
        DV_PROPORTION[id4.2] ∈ {
            numerator ∈ {|2.0..10.0|}
            type ∈ {1} -- pk_unitary
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, instance data may only be of type <code>DV_QUANTITY</code> or <code>DV_PROPORTION</code>, and must satisfy the respective constraints for those types.</p>
</div>
<div class="paragraph">
<p>A final variant of subtyping is when the intention is to constraint the data to a supertype with exceptions for particular subtypes. In this case, constraints based on subtypes are matched first, with the constraint based on the parent type being used to constrain all other subtypes. The following example constrains data at the <em>value</em> node to be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an instance of <code>DV_QUANTITY</code> with <em>magnitude</em> within the given range etc;</p>
</li>
<li>
<p>an instance of <code>DV_PROPORTION</code> with <em>numerator</em> in the given range etc;</p>
</li>
<li>
<p>an instance of any other subtype of <code>DV_AMOUNT</code> , with <em>accuracy</em> in the given range.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    .../value ∈ {
        DV_QUANTITY[id4] ∈ {
            magnitude ∈ {|2.0..10.0|}
            units ∈ {"mmol/ml"}
        }
        DV_PROPORTION[id5] ∈ {
            numerator ∈ {|2.0..10.0|}
            type ∈ {pk_unitary}
        }
        DV_AMOUNT[id6] ∈ {
            accuracy ∈ {|-0.05..0.05|}
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A typical use of this kind of refinement in openEHR would be to add an alternative for a <code>DV_CODED_TEXT</code> constraint for a specific terminology to an existing <code>DV_TEXT</code> constraint in a <code><em>name</em></code> attribute, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">definition
    ...
        name ∈ {
            DV_CODED_TEXT[id79] ∈ {
                defining_code ∈ {[ac1]}
            }
            DV_TEXT[id14] ∈ {
                value ∈ {/.+/} -- non-empty string
            }
        }
    ...

terminology
    ...
    term_bindings = &lt;
        ["snomed_ct"]    = &lt;
            ["ac1"] = &lt;http://snomed.info/123456789&gt; -- any SNOMED CT code
        &gt;
    &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>All of the above specialisation based on reference model subtypes can be applied in the same way to identified object constraints.</p>
</div>
</div>
<div class="sect2">
<h3 id="_internal_reference_proxy_object_redefinition"><a class="anchor" href="#_internal_reference_proxy_object_redefinition"></a><a class="link" href="#_internal_reference_proxy_object_redefinition">Internal Reference (Proxy Object) Redefinition</a></h3>
<div class="paragraph">
<p>An archetype proxy object, or <code>use_node</code> constraint is used to refer to an object constraint from a point elsewhere in the archetype. These references can be redefined in two ways, as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Target redefinition: the target constraint of reference may be itself redefined. The meaning for this is that all internal references now assume the redefined form.</p>
</li>
<li>
<p>Reference redefinition: specialised archetypes can redefine a use_node object into a normal inline concrete constraint that a) replaces the reference, and b) must be completely conformant to the structure which is the target of the original reference.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that if the intention is to redefine a structure referred to by <code>use_node</code> constraints, but to leave the constraints at the reference source points in form to which the reference points in the parent level, each <code>use_node</code> reference needs to be manually redefined as a copy of the target structure originally pointed to.</p>
</div>
<div class="paragraph">
<p>The second type of redefinition above is the most common, and is shown in the following example.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ENTRY[id1]∈ {
        data ∈ {
            CLUSTER[id2] ∈ {
                items ∈ {
                    -- etc --
                }
            }
            use_node CLUSTER[id3] /data[id2]
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ENTRY [id1.1]∈ {
        /data[id3]/items ∈ {
            ELEMENT [id0.1] ∈ {
                -- etc --
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remembering that the parent archetype is essentially just definition two sibling object structures with the identifiers <code>id1</code> and <code>id2</code> (defined by the use_node reference), the child is redefining the id2 node (it could also have redefined the id1 node as well). The result of this in the flattened output is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ENTRY [id1.1] ∈ {
        data ∈ {
            CLUSTER[id2] ∈ {
                items ∈ {
                    -- etc --
                }
            }
            CLUSTER[id3] ∈ {
                items ∈ {
                    ELEMENT[id0.1] ∈ {
                        -- etc --
                    }
                }
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is one subtlety to do with redefinition of occurrences of a use_node target: if it is redefined to have occurrences matches <code>{0}</code> (normally only in a template), then the effect of this is the same on any use_node reference definitions, unless they define occurrences locally at the reference point. The chance of this actually occurring appears vaninshingly small, since by the time 'exclusion' occurrence redefinition is being done in templates, use_node object definitions are most likely to have been locally overridden anyway.</p>
</div>
<div class="paragraph">
<p>Lastly, one further type of redefinition appears technically possible, but seems of no utility, and is therefore not part of ADL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reference re-targetting: an internal reference could potentially be redefined into a reference to a different target whose structure conforms to the original target.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_external_reference_redefinition"><a class="anchor" href="#_external_reference_redefinition"></a><a class="link" href="#_external_reference_redefinition">External Reference Redefinition</a></h3>
<div class="paragraph">
<p>External reference nodes can be redefined by another external reference node, in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>exclusion - using the occurrences matches <code>{0}</code> method;</p>
</li>
<li>
<p>semantic refinement of the node identifier in the normal way;</p>
</li>
<li>
<p>redefinition of the reference to another archetype which is a specialisation of the one from the corresponding reference node in the flat parent.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_slot_filling_and_redefinition"><a class="anchor" href="#_slot_filling_and_redefinition"></a><a class="link" href="#_slot_filling_and_redefinition">Slot Filling and Redefinition</a></h3>
<div class="paragraph">
<p>Slots and slot-filling is a special kind of 'redefinition' in ADL, normally only used in templates. Logically, an archetype slot constraint is understood to consist of a) its definition (what archetypes are allowed to fill it) and b) current filler list. At the point of definition, the current fillers is invariably empty. More specialised descendants can progressively add or replace fillers for a slot. Thus, the appearance of an object node whose identifier is the specialisation of a slot node in the flat parent is always understood as a partial specialisation for it.</p>
</div>
<div class="paragraph">
<p>In other words, a slot within an archetype can be specialised by any combination of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>one or more slot-fillers;</p>
</li>
<li>
<p>a redefinition of the slot itself, either to narrow the set of archetypes it matches, or to close it to filling in either further specialisations, or at runtime, or to remove it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both types of redefinition are generally used by templates rather than published archetypes, since the business of filling slots is mostly related to local use-case specific uses of archetypes rather than part of the initial design.</p>
</div>
<div class="paragraph">
<p>The following example shows a slot from a <code>SECTION</code> archetype for the 'history_medical_surgical' archetype.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    SECTION[id1] ∈ {    -- Past history
        items ∈ {
            allow_archetype EVALUATION[id2] ∈ { -- Past problems
                include
                    archetype_id/value ∈ {
                        /openEHR-EHR-EVALUATION\.clinical_synopsis\.v1
                            |openEHR-EHR-EVALUATION\.excluded(-[a-z0-9_]+)*\.v1
                            |openEHR-EHR-EVALUATION\.injury\.v1
                            |openEHR-EHR-EVALUATION\.problem(-[a-z0-9_]+)*\.v1/}
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This slot specification allows <code>EVALUATION</code> archetypes for the concepts 'clinical synopsis', various kinds of 'exclusions' and 'problems', and 'injury' to be used, and no others. The following fragment of ADL shows how the slot is filled in a template, using the keyword <code>use_archetype</code>. In this syntax, the node identification is a variation on the normal archetype id-codes. Within the template, the identifier of the used archetype is also the identifier of that node. However, the original at-code (if defined) must also be mentioned, so as to indicate which slot the used archetype is filling. Templates may also be used to fill slots in the same way. Thus, in the following example, two archetypes and a template are designated to fill the id2 slot defined in the above fragment of ADL. The slot definition is not mentioned, so it remains unchanged, i.e. 'open'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    SECTION[id1] ∈ {    -- Past history
        /items ∈ {
            use_archetype EVALUATION[id2, org.openehr::openEHR-EHR-EVALUATION.problem.v1]
            use_archetype EVALUATION[id2, uk.nhs.cfh::openEHR-EHR-EVALUATION.t_ed_diagnosis.v1]
            use_archetype EVALUATION[id2, org.openehr::openEHR-EHR-EVALUATION.clin_synopsis.v1]
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Slots can be recursively filled in the above fashion, according to the possibilities offered by the chosen archetypes or templates. The following ADL fragment shows two levels of slot-filling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    use_archetype COMPOSITION[openEHR-EHR-COMPOSITION.xxx.v1] ∈ {
        /content ∈ {
            use_archetype SECTION[id1, org.openehr::openEHR-EHR-SECTION.yyy.v1] ∈ {
                /items ∈ {
                    use_archetype EVALUATION[id2, uk.nhs.cfh::openEHR-EHR-EVALUATION.t_xx.v1]
                    use_archetype EVALUATION[id2, org.openehr::openEHR-EHR-EVALUATION.xx.v1]
                    use_archetype EVALUATION[id3, org.openehr::openEHR-EHR-EVALUATION.xx.v1]
                }
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in the above the archetype fillers are specified as published archetypes, but in reality, it is far more likely that template-specific specialisations of these archetypes would be used. The identification and organisation of such archetypes is described in the openEHR Templates document.</p>
</div>
<div class="paragraph">
<p>In addition to or instead of specifying slot fillers, it is possible in a slot specialisation to narrow the slot definition, or to close it. If fillers are specified, closing the slot as well is typical. The latter is done by including an overridden version of the archetype slot object itself, with the 'closed' constraint set, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    use_archetype SECTION[org.openehr::openEHR-EHR-SECTION.history_medical_surgical.v1] ∈ {
        /items ∈ {
            use_archetype EVALUATION[id2, openEHR-EHR-EVALUATION.problem.v1]
            allow_archetype EVALUATION[id2] closed
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Narrowing the slot is done with a replacement ` allow_archetype` statement containing a narrowed set of match criteria.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unconstrained_attributes"><a class="anchor" href="#_unconstrained_attributes"></a><a class="link" href="#_unconstrained_attributes">Unconstrained Attributes</a></h3>
<div class="paragraph">
<p>The <code>use_archetype</code> keyword can be used to specify child object constraints under any attribute in the reference model that is so far unconstrained by the flat parent of an archetype or template. Technically this could occur in any kind of archetype but would normally be in a specialised archetype or template. This is no more than the standard use of an 'external reference' (see <a href="#_external_references">[_external_references]</a>).</p>
</div>
<div class="paragraph">
<p>Any reference specified will have no slot, and is instead validity-checked against the appropriate part of the underlying reference model.</p>
</div>
<div class="paragraph">
<p>The following example from the openEHR reference model is typical.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    COMPOSITION[id1] matches {               -- Referral document
        category matches {...}
        context matches {
            EVENT_CONTEXT[id2] matches {
                participations matches {...}
                other_context matches {...}
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above cADL block partially specifies a <code>COMPOSITION</code> object, via constraints (often including slot definitions) on the <em>category</em> and <em>context</em> attributes defined on that class in the reference model. However, the attribute of most interest in a <code>COMPOSITION</code> object is usually the <em>content</em> attribute, which is not constrained at all here. The reference model defines it to be of type <code>List&lt;CONTENT_ITEM&gt;</code> .</p>
</div>
<div class="paragraph">
<p>Using an external reference in an unarchetyped part of the RM structure is almost always done in specialised archetypes or templates, but is valid in a top-level archetype.</p>
</div>
<div class="paragraph">
<p>The following example shows the use of <code>use_archetype</code> within a specialised archetype.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    COMPOSITION[id1.1] matches {        -- Referral document (specialisation)
        content matches {
            use_archetype SECTION[id2, openEHR-EHR-SECTION.history_medical_surgical.v1]
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_primitive_object_redefinition"><a class="anchor" href="#_primitive_object_redefinition"></a><a class="link" href="#_primitive_object_redefinition">Primitive Object Redefinition</a></h3>
<div class="paragraph">
<p>For terminal objects (i.e. elements of the type <code>C_PRIMITIVE_OBJECT</code>) redefinition consists of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>addition of value constraints for nodes which in the parent are constrained solely to a primitive type (described in <a href="#cADL_Constraints_Primitive_Types">[cADL_Constraints_Primitive_Types]</a>);</p>
</li>
<li>
<p>redefined value ranges or sets using a narrower value range or set;</p>
</li>
<li>
<p>exclusions on the previously defined value ranges or sets which have the effect of narrowing the original range or set.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_numeric_primitive_redefinition"><a class="anchor" href="#_numeric_primitive_redefinition"></a><a class="link" href="#_numeric_primitive_redefinition">Numeric Primitive Redefinition</a></h4>
<div class="paragraph">
<p>The following example shows a redefined real value range.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    value ∈ {
        DV_QUANTITY[id3] ∈ {
            magnitude ∈ {|2.0..10.0|}
            units ∈ {"mmol/ml"}
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specialised archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    .../value ∈ {
        DV_QUANTITY[id3] ∈ {
            magnitude ∈ {|4.0..6.5|}
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_terminology_internal_value_set_redefinition"><a class="anchor" href="#_terminology_internal_value_set_redefinition"></a><a class="link" href="#_terminology_internal_value_set_redefinition">Terminology Internal Value Set Redefinition</a></h4>
<div class="paragraph">
<p>The following example shows a redefined internal value set.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">definition
    ...
        ELEMENT[id7] occurrences ∈ {0..*} ∈ {   -- System
            name ∈ {
                DV_CODED_TEXT[id14] ∈ {
                    defining_code ∈ {[ac1]}
                }
            }
        }
    ...

terminology
    ...
    value_sets = &lt;
        ["ac1"] = &lt;
            id = &lt;"ac1"&gt;
            members = &lt;
                "at8",    -- Cardiovascular system
                "at9",    -- Respiratory system
                "at10",   -- Gastro-intestinal system
                "at11",   -- Reticulo-Endothelial system
                "at12",   -- Genito-urinary system
                "at13",   -- Endocrine System
                "at14",   -- Central nervous system
                "at15"    -- Musculoskeletal system
            &gt;
        &gt;
    &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specialised archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">definition
    .../name[id14]/defining_code ∈ {[ac1.1]}

terminology
    ...
    value_sets = &lt;
        ["ac1.1"] = &lt;
            id = &lt;"ac1.1"&gt;
            members = &lt;
                "at10",   -- Gastro-intestinal system
                "at11",   -- Reticulo-Endothelial system
                "at12",   -- Genito-urinary system
                "at13",   -- Endocrine System
                "at15"    -- Musculoskeletal system
            &gt;
        &gt;
    &gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_terminology_external_subset_redefinition"><a class="anchor" href="#_terminology_external_subset_redefinition"></a><a class="link" href="#_terminology_external_subset_redefinition">Terminology External Subset Redefinition</a></h4>
<div class="paragraph">
<p>A terminology external subset constraint is used to set the value set of a coded term to be one defined externally in a terminology, specified in the <code>term_definitions</code> sub-section of the <code>terminology</code> section, as shown in the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">definition
    ELEMENT [id79] ∈ { -- cuff size
        value ∈ {
            DV_CODED_TEXT[id4] ∈ {
                defining_code ∈ {[ac1]}
            }
        }
    }

terminology
    term_bindings = &lt;
        ["snomed_ct"]    = &lt;
            ["ac1"] = &lt;http://terminology.org/id/12000001&gt;
        &gt;
    &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a specialisation of the archetype, the value set reference can be redefined in two different ways. The first is by redefinition of the constraint to a narrower one. This is a achieved by redefining the constraint code, and adding a new definition in the terminology of the specialised archetype, as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">definition
    ELEMENT [id79] ∈ {               -- cuff size
        value ∈ {
            DV_CODED_TEXT[id14] ∈ {
                defining_code ∈ {[ac1.1]}
            }
        }
    }

terminology
    term_bindings = &lt;
        ["snomed_ct"]    = &lt;
            ["ac1.1"] = &lt;http://terminology.org/id/12000002&gt;
        &gt;
    &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second kind of redefinition is by an internal value set, as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">terminology
    ...
    value_sets = &lt;
        ["ac1"] = &lt;
            id = &lt;"ac1"&gt;
            members = "&lt;at22",   -- child cuff
                      "at23"&gt;    -- infant cuff
        &gt;
    &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These redefinitions are assumed to be valid, although it is not directly validatable unless the terminology subset is available to the tooling.</p>
</div>
<div class="paragraph">
<p>A third variation is when a term constraint is used as a redefinition of a previously unconstrained term code, e.g. as shown in the following fragment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    ELEMENT[id79] ∈ { -- cuff size
        value ∈ {
            DV_CODED_TEXT[id14]
        }
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tuple_redefinition"><a class="anchor" href="#_tuple_redefinition"></a><a class="link" href="#_tuple_redefinition">Tuple Redefinition</a></h3>
<div class="paragraph">
<p>Tuple constraints can be redefined by narrowing, as for other primitive constraints. A typical example is as follows.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    DV_QUANTITY[id42] ∈ {
        property ∈ {[at29]}
        [magnitude, units] ∈ {
            [{|&gt;=50.0|}, {"mm[Hg]"}],
            [{|&gt;=68.0|}, {"cm[H20]"}]
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cadl" data-lang="cadl">    DV_QUANTITY[id42] ∈ {
        property ∈ {[at29]}
        [magnitude, units] ∈ {
            [{|&gt;=50.0|}, {"mm[Hg]"}]
        }
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rules"><a class="anchor" href="#_rules"></a><a class="link" href="#_rules">Rules</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>rules</code> section in an archetype consists of definitions and assertion statements. Assertions in archetypes have the effect of further reducing the instance space that conforms to an archetype by specifying relationships between values that must hold. For example the main part of an archetype may specify that the existence of a subtree, containing data points related to 'tobacco use' for example, is dependent on the value of another data point representing 'smoker?' being True.</p>
</div>
<div class="paragraph">
<p>In specialised archetypes, further invariants can be added, but existing ones cannot be changed. New invariants cannot logically contradict existing invariants and are considered to be logically related to invariants from the flat parent by the logical semi-strict operator 'and then'.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_languages"><a class="anchor" href="#_languages"></a><a class="link" href="#_languages">Languages</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A specialised archetype or template is only required to have one language in common with its flat precursor, enabling a flat output containing this language. This supports the common situation in which an international standard archetype with numerous translations is used as a basis for further specialisation in a particular country or project. Clearly, the latter has no need of, and quite probably no capability for including all the original translations in the specialisation.</p>
</div>
<div class="paragraph">
<p>However, if the specialised archetype language is not present at all in the parent flat, it will need to be added to the archetypes in the specialisation lineage first.</p>
</div>
<div class="paragraph">
<p>The languages present in the flat output will therefore be those languages available in both the flat parent (implying all previous archetypes / templates in the specialisation lineage) and the new specialisation. Any new languages introduced in the latter not available in the flat parent will be discarded.</p>
</div>
<div class="paragraph">
<p>Locale-specific overrides can be introduced for any linguistic element in an archetype, including the terminology. Such an override has a language code conforming to a subset of the <a href="https://tools.ietf.org/html/rfc5646">IETF RFC 5646 language tag standard</a>, namely the common 2-part language-region tag exemplified by 'en-GB' (British English), 'pt-BR' (Brazilian Portuguese), and so on. The tags are case-insensitive, but tools that create tags should follow the recommendation from the standard, which is that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>language tag is lowercase;</p>
</li>
<li>
<p>region tags are uppercase.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_description_section"><a class="anchor" href="#_description_section"></a><a class="link" href="#_description_section">Description Section</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>description</code> section of a specialised archetype or template always replaces that of the parent in the flattened result. The obvious alternative would be automatic inclusion of the corresponding <code>description</code> section elements from  precursor archetypes back up the specialisation lineage. The replacement approach is justified by the thinking that the documentary view of a specialised archetype, and particular a template, in their flattened form is likely to be most useful if it consists of the descriptions created by the developers of those specialised artefacts, rather than an accumulation of copies of the documentation elements down the lineage, since tools or special visualisations could provide views of each part of the description back up the specialisation hierarchy if required.</p>
</div>
<div class="paragraph tbd">
<p><strong>TBD</strong>: A third alternative, used in some programming languages the enable comments to be inherited might be to optionally include the test of a descriptive element of a parent archetype within the corresponding element of the child, for example by including a special string like <code><a href="#precursor">[precursor]</a></code> somewhere in the text. The flattener would search for this, iand if found, include the text from the parent. To have the effect of inclusion of all parent text elements, something like <code><a href="#all_precursors">[all_precursors]</a></code> could be used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terminology"><a class="anchor" href="#_terminology"></a><a class="link" href="#_terminology">Terminology</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Specialisation in the <code>terminology</code> section manifests in terms of specialised and added terms in the <code>term_definitions</code> sub-section.</p>
</div>
<div class="paragraph">
<p>Value sets can be specialised, which has the effect in the flattened form of replacing the original rather than adding to it, as shown in the following example.</p>
</div>
<div class="paragraph">
<p>Parent archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">archetype (adl_version=2.0.0; generated)
    openEHR-EHR-EVALUATION.code_list_parent.v1.0.0

language
    original_language = &lt;[ISO_639-1::en]&gt;

description
    ...

definition
    EVALUATION[id1] matches {   -- General statement of exclusions or states
        data matches {
            ITEM_TREE[id2] matches {
                items cardinality matches {1..*; unordered} matches {
                    ELEMENT[id3] occurrences matches {1..*} matches {   -- Statement
                        value matches {
                            DV_CODED_TEXT[id4] matches {
                                defining_code matches {[ac1]}       -- Statement
                            }
                        }
                    }
                }
            }
        }
    }

terminology
    term_definitions = &lt;
        ["en"] = &lt;
            ["id1"] = &lt;
                text = &lt;"General statement of exclusions or states"&gt;
                description = &lt;"A category of ... have been excluded"&gt;
            &gt;
            ["id3"] = &lt;
                text = &lt;"Statement"&gt;
                description = &lt;"The statement about what is excluded"&gt;
            &gt;
            ["at4"] = &lt;
                text = &lt;"No significant illness"&gt;
                description = &lt;"The person ... condition"&gt;
            &gt;
            ["at5"] = &lt;
                text = &lt;"No significant past history"&gt;
                description = &lt;"The person has no ... history"&gt;
            &gt;
            ...
            ["at13"] = &lt;
                text = &lt;"No relevant family history"&gt;
                description = &lt;"No family history ... situation"&gt;
            &gt;
            ["at14"] = &lt;
                text = &lt;"No known allergies"&gt;
                description = &lt;"No allergies known to any ... or substances"&gt;
            &gt;
            ["ac1"] = &lt;
                text = &lt;"Statement"&gt;
                description = &lt;"The statement about what is excluded"&gt;
            &gt;
        &gt;
    &gt;
    value_sets = &lt;
        ["ac1"] = &lt;
            id = &lt;"ac1"&gt;
            members = &lt;"at4", "at5", "at6", "at7", "at10", "at13", "at14", "at11", "at12", "at8", "at9"&gt;
        &gt;
    &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Flattened child archetype:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-adl" data-lang="adl">archetype (adl_version=2.0.0; generated)
    openEHR-EHR-EVALUATION.code_list_constrained.v1.0.0

    -- ...

terminology
    term_definitions = &lt;
        ["en"] = &lt;
            ["id1"] = &lt;
                text = &lt;"General statement of exclusions or states"&gt;
                description = &lt;"A category of ...have been excluded"&gt;
            &gt;
            ["id3"] = &lt;
                text = &lt;"Statement"&gt;
                description = &lt;"The statement about what is excluded"&gt;
            &gt;
            ...
            ["at13"] = &lt;
                text = &lt;"No relevant family history"&gt;
                description = &lt;"No family history relevant .. situation"&gt;
            &gt;
            ["ac1"] = &lt;
                text = &lt;"Statement"&gt;
                description = &lt;"The statement about what is excluded"&gt;
            &gt;
            ["ac1.1"] = &lt;
                text = &lt;"(added by post-parse processor)"&gt;
                description = &lt;"(added by post-parse processor)"&gt;
            &gt;
            ["id1.1"] = &lt;
                text = &lt;"Adverse reaction exclusions"&gt;
                description = &lt;"A category of ... of adverse reaction"&gt;
            &gt;
        &gt;
    &gt;
    value_sets = &lt;
        ["ac1.1"] = &lt;
            id = &lt;"ac1.1"&gt;
            members = &lt;"at6", "at7", "at10", "at13"&gt;
        &gt;
    &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The flattened result always includes the sum of term definitions from the parent.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bindings"><a class="anchor" href="#_bindings"></a><a class="link" href="#_bindings">Bindings</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bindings in a specialised archetype can include a binding to an at-code or ac-code defined in the current archetype or any parent archetype. A binding may be defined that overrides one from the flat parent, in which case the binding target - a term (at-code binding) or value set (ac-code binding) should be a proper specialised concept or subset respectively of the binding they replace. Since the binding target is an external code or subset, authoring tools need a connection to an appropriate terminology service to validate the relationship.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../terminology_integration/">Terminology Integration</a></span>
  <span class="next"><a href="../templates/">Templates</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>
    Copyright: © 2003+
    <a href="https://www.openehr.org"
        alt="is an independent, non-profit foundation, facilitating the sharing of health
           records by consumers and clinicians via open specifications, clinical models
           and open platform implementations.">The openEHR Foundation</a>
  </p>

  <p>
    License:
    <img src="/_/img/cc-by-nd-88x31.png"
        alt="Creative Commons Attribution-NoDerivs 3.0 Unported."
        style="vertical-align:middle;margin:0 0.25rem 0 0;">
    <a href="https://creativecommons.org/licenses/by-nd/3.0/">
      Creative Commons Attribution-NoDerivs 3.0 Unported.
    </a>
  </p>

  <p>
    <strong>Links: <strong>
    <a href="https://www.openehr.org/terms-of-use" class="mr-1">Terms of use</a> |
    <a href="https://www.openehr.org/privacy-policy" class="mx-1">Privacy policy</a> |
    <a href="https://www.openehr.org/privacy-policy" class="mx-1">Logos &amp; Trademarks</a> |
    <a href="https://www.openehr.org/contact-us" class="mx-1">Contact</a>
  </p>
</footer>

<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="80" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/medium-zoom.min.js"></script>
<script src="../../../../_/js/zoom.js"></script>
  </body>
</html>
